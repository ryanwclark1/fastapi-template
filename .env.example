# ==============================================================================
# FastAPI Service Configuration
# ==============================================================================
# This file shows all available environment variables for configuration.
# Copy this file to .env and customize for your local development.
#
# Configuration Precedence (highest to lowest):
#   1. Environment variables (production - use Kubernetes ConfigMap/Secret)
#   2. .env file (development only)
#   3. Default values in settings classes
#
# See core/settings/ for all available settings modules.
# ==============================================================================

# ------------------------------------------------------------------------------
# Docker Compose Infrastructure
# ------------------------------------------------------------------------------
# Supporting services live in deployment/docker/docker-compose.yml and can be
# started via the VS Code task "infra:docker-compose up" or with docker compose
# directly. Service name -> localhost port mappings:
#   db         -> 5432 (PostgreSQL)
#   redis      -> 6379 (Redis)
#   rabbitmq   -> 5672 (AMQP) / 15672 (management UI)
#   tempo      -> 4317 (OTLP gRPC), 4318 (OTLP HTTP), 3200 (Tempo query)
#   loki       -> 3101
#   prometheus -> 9090
#   alloy      -> 12345
#   grafana    -> 3000
# Use localhost when running FastAPI on the host. Replace localhost with the
# container name if the app runs inside docker compose.

# ------------------------------------------------------------------------------
# Application Settings (APP_)
# ------------------------------------------------------------------------------
APP_SERVICE_NAME=example-service
APP_TITLE=Example Service API
APP_VERSION=1.0.0
APP_ENVIRONMENT=development  # development|staging|production
APP_DEBUG=false
APP_HOST=0.0.0.0
APP_PORT=8000

# API Documentation
APP_DOCS_URL=/docs
APP_REDOC_URL=/redoc
APP_OPENAPI_URL=/openapi.json
APP_DISABLE_DOCS=false
# Root path for proxy/ingress (e.g., /api/v1)
APP_ROOT_PATH=

# CORS Configuration
# JSON array format: APP_CORS_ORIGINS=["http://localhost:3000","https://app.example.com"]
# Or empty for wildcard: APP_CORS_ORIGINS=[]
APP_CORS_ORIGINS=["http://localhost:3000"]
APP_CORS_ALLOW_CREDENTIALS=true
APP_CORS_ALLOW_METHODS=["*"]
APP_CORS_ALLOW_HEADERS=["*"]

# ------------------------------------------------------------------------------
# Database Settings (DB_) - PostgreSQL with psycopg3
# ------------------------------------------------------------------------------
# SQLAlchemy 2.x with psycopg3 async driver
DB_DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/example_service
# DB_DATABASE_URL=postgresql+psycopg://postgres:postgres@db:5432/example_service  # When the app runs inside docker compose
# DB_DATABASE_URL=postgresql+psycopg://user:pass@/dbname?host=/var/run/postgresql  # Unix socket
# DB_DATABASE_URL=postgresql+psycopg://user:pass@host/db?sslmode=require  # With SSL

# Connection Pool Settings (SQLAlchemy)
DB_POOL_SIZE=10
DB_POOL_MIN=1
DB_MAX_OVERFLOW=10
DB_POOL_TIMEOUT=30
DB_POOL_RECYCLE=1800  # Recycle connections after 30 minutes
DB_POOL_PRE_PING=true
DB_ECHO_SQL=false

# psycopg3 Native Pool Settings (if using driver-only path)
DB_PG_MIN_SIZE=1
DB_PG_MAX_SIZE=10
DB_PG_MAX_IDLE=null
DB_PG_TIMEOUT=30.0

# ------------------------------------------------------------------------------
# Redis Cache Settings (REDIS_)
# ------------------------------------------------------------------------------
REDIS_REDIS_URL=redis://localhost:6379/0
# REDIS_REDIS_URL=redis://redis:6379/0  # When the app runs inside docker compose
# REDIS_REDIS_URL=redis://:password@localhost:6379/0  # With password
# REDIS_REDIS_URL=rediss://localhost:6380/0  # With TLS

# Cache TTL Settings (seconds)
REDIS_DEFAULT_TTL=3600        # 1 hour
REDIS_AUTH_TOKEN_TTL=300      # 5 minutes

# Connection Pool
REDIS_POOL_SIZE=10
REDIS_POOL_TIMEOUT=10

# Retry Settings
REDIS_MAX_RETRIES=3
REDIS_RETRY_DELAY=0.5

# Key Prefix (for multi-tenant/environment isolation)
REDIS_KEY_PREFIX=example-service:

# ------------------------------------------------------------------------------
# RabbitMQ Messaging Settings (RABBIT_)
# ------------------------------------------------------------------------------
RABBIT_RABBITMQ_URL=amqp://admin:admin123@localhost:5672/
# RABBIT_RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/  # When the app runs inside docker compose
# RABBIT_RABBITMQ_URL=amqps://user:pass@host:5671/vhost  # With TLS

# Queue Configuration
RABBIT_QUEUE_PREFIX=example-service
RABBIT_EXCHANGE=example-service
RABBIT_QUEUE=tasks_queue

# Consumer Settings
RABBIT_PREFETCH_COUNT=100
RABBIT_MAX_CONSUMERS=10
RABBIT_POOL_SIZE=10

# Graceful Shutdown
RABBIT_GRACEFUL_TIMEOUT=15.0

# ------------------------------------------------------------------------------
# External Authentication Settings (AUTH_)
# ------------------------------------------------------------------------------
AUTH_SERVICE_URL=http://localhost:8001
AUTH_TOKEN_VALIDATION_ENDPOINT=/api/v1/auth/validate
AUTH_TOKEN_CACHE_TTL=300  # seconds
AUTH_TOKEN_HEADER=Authorization
AUTH_TOKEN_SCHEME=Bearer

# Service-to-Service Authentication
# AUTH_SERVICE_TOKEN=your-service-token-here
# AUTH_SERVICE_ID=example-service

# Request Settings
AUTH_REQUEST_TIMEOUT=5.0
AUTH_MAX_RETRIES=3

# Feature Flags
AUTH_ENABLE_PERMISSION_CACHING=true
AUTH_ENABLE_ROLE_CACHING=true

# ------------------------------------------------------------------------------
# Logging Settings (LOG_)
# ------------------------------------------------------------------------------
LOG_LEVEL=INFO  # DEBUG|INFO|WARNING|ERROR|CRITICAL
LOG_JSON=true   # Structured JSON logs
LOG_INCLUDE_UVICORN=true

# Log File Configuration
LOG_LOG_FILE=logs/example-service.log.jsonl
LOG_MAX_BYTES=10485760  # 10MB
LOG_BACKUP_COUNT=5

# Console Logging
LOG_CONSOLE_ENABLED=true

# Request ID Tracking
LOG_INCLUDE_REQUEST_ID=true

# Performance Logging
LOG_LOG_SLOW_REQUESTS=true
LOG_SLOW_REQUEST_THRESHOLD=1.0  # seconds

# ------------------------------------------------------------------------------
# OpenTelemetry Tracing Settings (OTEL_)
# ------------------------------------------------------------------------------
OTEL_ENABLED=false
OTEL_ENDPOINT=http://localhost:4317  # Tempo, Jaeger, or other OTLP collector
# OTEL_ENDPOINT=http://tempo:4317  # When FastAPI also runs inside docker compose

# Service Identification
OTEL_SERVICE_NAME=example-service
OTEL_SERVICE_VERSION=1.0.0

# Connection Settings
OTEL_INSECURE=true  # Use insecure connection (local dev)
OTEL_TIMEOUT=10

# Sampling
OTEL_SAMPLE_RATE=1.0  # 0.0-1.0 (1.0 = 100% sampling)

# Instrumentation Toggles
OTEL_INSTRUMENT_FASTAPI=true
OTEL_INSTRUMENT_HTTPX=true
OTEL_INSTRUMENT_SQLALCHEMY=true
OTEL_INSTRUMENT_PSYCOPG=true

# ==============================================================================
# Optional: YAML/conf.d File Sources
# ==============================================================================
# Override these to use YAML files for configuration (local/dev convenience)
# Files are loaded BEFORE environment variables, so ENV always wins.
#
# APP_CONFIG_DIR=conf
# DB_CONFIG_DIR=conf
# RABBIT_CONFIG_DIR=conf
# LOGGING_CONFIG_DIR=conf
# OTEL_CONFIG_DIR=conf
#
# Directory structure example:
#   conf/
#   ├── app.yaml
#   ├── app.d/
#   │   ├── 01-cors.yml
#   │   └── 02-docs.yml
#   ├── db.yaml
#   └── rabbit.yaml
#
# ==============================================================================

# ==============================================================================
# Kubernetes/Docker Secrets
# ==============================================================================
# In production, prefer injecting sensitive values via Kubernetes Secrets:
#
# env:
#   - name: DB_DATABASE_URL
#     valueFrom:
#       secretKeyRef:
#         name: db-secret
#         key: DATABASE_URL
#   - name: REDIS_REDIS_URL
#     valueFrom:
#       secretKeyRef:
#         name: redis-secret
#         key: REDIS_URL
# ==============================================================================
